### 项目介绍

本项目是 OpenZeppelin Relayer 的 Rust 实现, 负责为多链账户提供交易创建, 签名, 提交, 状态跟踪, 重试与通知等能力.  
其中 EVM 使用 nonce, Stellar 使用 sequence. 代码里统一抽象为 transaction counter.

### Nonce 管理与生命周期总览

#### 计数器抽象与存储

- **统一接口**: `TransactionCounterTrait`  
  - `get(relayer_id, address) -> Option<u64>`
  - `get_and_increment(relayer_id, address) -> u64` 先返回当前值再自增
  - `decrement(relayer_id, address) -> u64` 仅实现, 当前主流程没有调用点
  - `set(relayer_id, address, value)`
- **实现**:  
  - `InMemoryTransactionCounter` 使用 `DashMap<(relayer_id, address), u64>`  
  - `RedisTransactionCounter` 使用 Redis `INCR/DECR/GET/SET`  
    - key 规则: `{key_prefix}:transaction_counter:{relayer_id}:{address}`
- **服务封装**: `TransactionCounterService` 把 `relayer_id` 和 `address` 绑定到实例里, 提供 `get/get_and_increment/set/decrement`.  
  - EVM relayer 的 `sync_nonce` 走 `TransactionCounterService`  
  - EVM transaction 准备阶段直接调用 `TransactionCounterTrait.get_and_increment(relayer_id, address)`  
  - Stellar relayer 和 Stellar transaction 都使用 `TransactionCounterService` 或直接 `TransactionCounterTrait.set`

#### Mermaid 流程图

```mermaid
flowchart TD

%% -------------------------
%% storage and counter layer
%% -------------------------
subgraph S[计数器与存储层]
  S0[启动初始化 AppState]
  S1{repository_storage_type}
  S2[InMemoryTransactionCounter]
  S3[RedisTransactionCounter]
  S4[TransactionCounterTrait]
  S5[TransactionCounterService 绑定 relayer_id 和 address]
  S6[Redis key: prefix:transaction_counter:relayer_id:address]

  S0 --> S1
  S1 -->|InMemory| S2 --> S4
  S1 -->|Redis| S3 --> S4
  S3 -.-> S6
  S5 --> S4
end

%% -------------------------
%% EVM nonce lifecycle
%% -------------------------
subgraph E[EVM nonce 生命周期]
  E0[relayer 初始化或 disabled relayer 健康检查]
  E1[调用 EvmRelayer.check_health]
  E2[sync_nonce]
  E3[provider.get_transaction_count 链上 nonce]
  E4[counter_service.get 本地计数器 nonce, None 视为 0]
  E5[nonce = max(链上 nonce, 本地 nonce)]
  E6[counter_service.set(nonce)]
  E7{健康检查通过}
  E8[relayer enable 或保持 enable]
  E9[relayer disable 并 schedule health check 重试]

  E0 --> E1 --> E2
  E2 --> E3 --> E5
  E2 --> E4 --> E5
  E5 --> E6 --> E7
  E7 -->|是| E8
  E7 -->|否| E9

  E10[收到 API 交易请求]
  E11[创建 TransactionRepoModel, 初始 status Pending]
  E12[produce TransactionRequest job]
  E13[produce TransactionStatusCheck job 延迟]

  E10 --> E11 --> E12 --> E13

  E20[TransactionRequest job: prepare_transaction]
  E21{tx.status == Pending}
  E22[估算 gas_limit 或校验用户 gas_limit 不超过 block gas limit]
  E23[price_calculator.get_transaction_price_params]
  E24[ensure_sufficient_balance]
  E25{余额不足}
  E26[mark_transaction_as_failed, status Failed]
  E27{tx.network_data.evm.nonce 已存在}
  E28[复用 existing nonce, 仅重新计算并应用价格参数用于签名]
  E29[counter.get_and_increment(relayer_id, address)]
  E30[为 tx 分配 new nonce]
  E31[presign_update: 先把 nonce 和 price_params 写入 DB, priced_at=now]
  E32[signer.sign_transaction]
  E33[postsign_update: 写入签名和 raw, 追加 hash, status Sent]
  E34[produce TransactionSend submit job]
  E35[通知发送 best effort]

  E20 --> E21
  E21 -->|否| E36[跳过 prepare, 返回原 tx]
  E21 -->|是| E22 --> E23 --> E24 --> E25
  E25 -->|是| E26
  E25 -->|否| E27
  E27 -->|是| E28 --> E32
  E27 -->|否| E29 --> E30 --> E31 --> E32
  E32 --> E33 --> E34 --> E35

  E40[TransactionSend submit: submit_transaction]
  E41{tx.status in Sent or Submitted}
  E42[provider.send_raw_transaction]
  E43{provider error indicates already submitted}
  E44[条件: tx.status==Sent 且 error 包含 already known 或 nonce too low 或 replacement transaction underpriced]
  E45[视为提交成功, 继续更新为 Submitted]
  E46[真实错误, 返回错误触发重试]
  E47[partial_update: status Submitted, sent_at=now]
  E48{DB 更新失败}
  E49[记录 CRITICAL, 返回原 tx 避免重复提交]
  E50[通知发送 best effort]

  E40 --> E41
  E41 -->|否| E51[跳过 submit, 返回原 tx]
  E41 -->|是| E42 --> E43
  E43 -->|是| E44 --> E45 --> E47
  E43 -->|否| E46
  E42 -->|Ok| E47
  E47 --> E48
  E48 -->|是| E49 --> E50
  E48 -->|否| E50

  E60[TransactionStatusCheck: handle_status_impl]
  E61[check_transaction_status]
  E62{tx.status is final}
  E63[return tx]
  E64{tx.status Pending or Sent}
  E65[check_transaction_status: Pending or Sent, no chain query]
  E201{status == Pending}
  E202[handle_pending_state]
  E203{should_noop}
  E204[Pending should_noop true: partial_update status Failed, notify]
  E205{age > pending_recovery_trigger_timeout}
  E206[requeue prepare: send_transaction_request_job]
  E207[return tx]
  E66[需要 tx_hash, provider.get_transaction_receipt]
  E67{receipt 存在}
  E68{receipt.status 成功}
  E69[status Failed]
  E70[provider.get_block_number, 检查 confirmations]
  E71{confirmations 足够}
  E72[status Confirmed]
  E73[status Mined]
  E74{receipt 不存在}
  E75[status Submitted]
  E76{hash recovery 条件满足}
  E77[遍历历史 hashes, 查询 receipt]
  E78{发现某个历史 hash 已 mined}
  E79[partial_update: 修正 hash, status Mined, 发送通知]
  E80[未发现, 保持 Submitted]

  E60 --> E61 --> E62
  E62 -->|是| E63
  E62 -->|否| E64
  E64 -->|是| E65 --> E201
  E201 -->|是| E202 --> E203
  E203 -->|是| E204
  E203 -->|否| E205
  E205 -->|是| E206 --> E207
  E205 -->|否| E207
  E201 -->|否| E120
  E64 -->|否| E66 --> E67
  E67 -->|是| E68
  E68 -->|否| E69
  E68 -->|是| E70 --> E71
  E71 -->|是| E72
  E71 -->|否| E73
  E67 -->|否| E74 --> E75 --> E76
  E76 -->|是| E77 --> E78
  E78 -->|是| E79
  E78 -->|否| E80
  E76 -->|否| E80

  E90[Submitted 状态超时: should_resubmit]
  E91{超过超时阈值}
  E92[handle_resubmission]
  E93{should_noop}
  E94[prepare_noop_update_request, noop_count+1, 可选 is_canceled]
  E95[partial_update, 发送通知]
  E96[produce resubmit job]

  E75 --> E90
  E90 --> E91
  E91 -->|是| E92 --> E93
  E93 -->|是| E94 --> E95 --> E96
  E93 -->|否| E96
  E91 -->|否| E97[仅更新或保持 Submitted]

  E100[resubmit_transaction: 重新签名并尝试提交]
  E101[price_calculator.calculate_bumped_gas_price]
  E102{is_min_bumped == true}
  E103[ensure_sufficient_balance]
  E104[signer.sign_transaction]
  E105[provider.send_raw_transaction]
  E106{error indicates already submitted}
  E107[保持原 hash, 仅确保 status Submitted]
  E108[更新 network_data 和 hashes, status Submitted, priced_at and sent_at]
  E109[DB 更新失败记录 CRITICAL, 返回原 tx]

  E100 --> E101 --> E102
  E102 -->|否| E110[跳过 resubmit, 返回原 tx]
  E102 -->|是| E103 --> E104 --> E105 --> E106
  E106 -->|是| E107
  E106 -->|否| E108
  E108 --> E111{DB 更新失败}
  E111 -->|是| E109
  E111 -->|否| E112[Ok]
  E107 --> E112

  E120[Sent 状态超时: handle_sent_state]
  E121{超过 resend timeout}
  E122[produce resubmit job]
  E123{should_noop}
  E124[Sent 状态 NOOP 后 produce submit job]

  E33 --> E120
  E120 --> E123
  E123 -->|是| E124
  E123 -->|否| E121
  E121 -->|是| E122
  E121 -->|否| E125[保持 Sent]

  E130[cancel_transaction]
  E131{tx.status == Pending}
  E132[直接更新 status Canceled]
  E133[Sent or Submitted: 生成 NOOP cancellation, is_canceled=true]
  E134[partial_update, produce resubmit job]

  E130 --> E131
  E131 -->|是| E132
  E131 -->|否| E133 --> E134

  E140[replace_transaction]
  E141[determine_replacement_pricing]
  E142[ensure_sufficient_balance]
  E143[signer.sign_transaction]
  E144[update_network_data]
  E145[produce resubmit job]

  E140 --> E141 --> E142 --> E143 --> E144 --> E145

  E160[delete_pending_transactions]
  E161[find_by_status: Pending, Sent, Submitted]
  E162[for each tx: produce TransactionSend cancel job]
  E163[返回 queued ids 和 failed ids, nonce 无变化]

  E160 --> E161 --> E162 --> E163
end

%% -------------------------
%% Stellar sequence lifecycle
%% -------------------------
subgraph T[Stellar sequence 生命周期]
  T0[relayer 初始化或 disabled relayer 健康检查]
  T1[sync_sequence]
  T2[fetch_next_sequence_from_chain]
  T3[counter_service.set(next_sequence)]

  T0 --> T1 --> T2 --> T3

  T10[prepare_transaction_impl]
  T11{顺序模式 lane_gate 可用}
  T12[TransactionCounter.get_and_increment 分配 sequence]
  T13[签名并写入 DB, status Sent]
  T14[submit job]
  T15{prepare 失败}
  T16[handle_prepare_failure]
  T17[sync_sequence_from_chain 总是执行]
  T18[标记 tx Failed 并清理 lane]

  T10 --> T11
  T11 -->|否| T19[跳过 prepare, 返回原 tx]
  T11 -->|是| T12 --> T13 --> T14
  T10 -->|Err| T15 --> T16 --> T17 --> T18
end

%% cross links
S0 --> E0
S0 --> T0

```

### 关键语义总结

- **nonce 分配点**: EVM 在 `prepare_transaction` 内, 余额校验通过后才调用 `get_and_increment`.  
- **nonce 可恢复性**: nonce 在签名前写入 DB, 所以签名失败重试时会复用同一个 nonce, 并重新计算价格参数用于签名.  
- **already submitted 判定**: 只要 provider error 包含 `already known` 或 `nonce too low` 或 `replacement transaction underpriced`, EVM 会把本次提交视为已经成功提交, 继续把状态推进到 Submitted.  
- **hash 恢复**: Submitted 长时间未出 receipt 且 hashes 足够多时, 会遍历历史 hashes 找到真正被 mined 的那一个并修正 DB.  
- **取消与替换**: cancel 和 replace 都不会回退 nonce, 而是通过同 nonce 的 NOOP 或重签名交易覆盖 mempool 中旧交易.


